
# Create fixed auth.html that properly handles the auth state
auth_html_fixed = """<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Login â€“ Five Roam Coffee</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --beige:#f5f0e8;--brown:#3e2a1a;--gold:#b8860b;--gold-light:#d4a843;
      --text:#2c1a0e;--white:#fffdf8;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:"Lato",sans-serif;
      background:linear-gradient(135deg,#1a0f07 0%,#3e2a1a 50%,#2c1a0e 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .auth-container{
      background:var(--white);
      border-radius:24px;
      padding:40px 36px;
      max-width:440px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.4);
    }
    .logo{
      font-family:"Playfair Display",serif;
      font-size:2rem;
      text-align:center;
      margin-bottom:8px;
      color:var(--brown);
    }
    .logo span{color:var(--gold);}
    .tagline{
      text-align:center;
      font-size:0.88rem;
      color:#6b5040;
      margin-bottom:32px;
    }
    .tabs{
      display:flex;
      gap:12px;
      margin-bottom:24px;
      border-bottom:2px solid var(--beige);
    }
    .tab-btn{
      flex:1;
      padding:12px;
      background:none;
      border:none;
      font-family:"Lato",sans-serif;
      font-size:0.9rem;
      font-weight:600;
      color:#9b8070;
      cursor:pointer;
      position:relative;
      transition:color 0.2s;
    }
    .tab-btn.active{
      color:var(--brown);
    }
    .tab-btn.active::after{
      content:"";
      position:absolute;
      bottom:-2px;
      left:0;
      right:0;
      height:2px;
      background:var(--gold);
    }
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .form-group{margin-bottom:16px;}
    .form-label{
      display:block;
      font-size:0.8rem;
      font-weight:700;
      color:var(--brown);
      margin-bottom:6px;
    }
    .form-input{
      width:100%;
      padding:12px 14px;
      border:1.5px solid #e8dfc8;
      border-radius:12px;
      font-family:"Lato",sans-serif;
      font-size:0.92rem;
      outline:none;
      transition:border-color 0.2s;
    }
    .form-input:focus{border-color:var(--gold);}
    .btn{
      width:100%;
      padding:14px;
      border:none;
      border-radius:24px;
      font-family:"Playfair Display",serif;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:all 0.25s;
    }
    .btn-primary{
      background:var(--gold);
      color:var(--white);
    }
    .btn-primary:hover{
      background:var(--gold-light);
      transform:translateY(-2px);
    }
    .btn-primary:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none;
    }
    .status-msg{
      margin-top:16px;
      padding:10px 14px;
      border-radius:10px;
      font-size:0.85rem;
      text-align:center;
      display:none;
    }
    .status-msg.success{background:#d4edda;color:#1a6b38;display:block;}
    .status-msg.error{background:#f8d7da;color:#8b1a1a;display:block;}
    .status-msg.info{background:#d1ecf1;color:#0c5460;display:block;}
    .link-text{
      text-align:center;
      margin-top:16px;
      font-size:0.85rem;
      color:#6b5040;
    }
    .link-text a{
      color:var(--gold);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }
    .link-text a:hover{
      text-decoration:underline;
    }
  </style>
</head>
<body>

<div class="auth-container">
  <div class="logo">Five<span>Roam</span></div>
  <div class="tagline">India's Finest Specialty Coffee</div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('login')">Login</button>
    <button class="tab-btn" onclick="switchTab('register')">Register</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- LOGIN TAB -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-login" class="tab-content active">
    <div class="form-group">
      <label class="form-label">Email or Phone</label>
      <input type="text" class="form-input" id="login-email" placeholder="email@example.com or +919876543210"/>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="login-password" placeholder="Enter your password"/>
    </div>
    <button class="btn btn-primary" onclick="handleLogin()">Login</button>
    <div class="link-text">
      <a onclick="switchTab('forgot')">Forgot Password?</a>
    </div>
    <div id="login-msg" class="status-msg"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- REGISTER TAB -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-register" class="tab-content">
    <div class="form-group">
      <label class="form-label">Full Name</label>
      <input type="text" class="form-input" id="reg-name" placeholder="Your full name"/>
    </div>
    <div class="form-group">
      <label class="form-label">Email Address</label>
      <input type="email" class="form-input" id="reg-email" placeholder="you@example.com"/>
    </div>
    <div class="form-group">
      <label class="form-label">Phone Number (Optional)</label>
      <input type="tel" class="form-input" id="reg-phone" placeholder="+91 9876543210"/>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="reg-password" placeholder="Min 6 characters"/>
    </div>
    <div class="form-group">
      <label class="form-label">Confirm Password</label>
      <input type="password" class="form-input" id="reg-confirm" placeholder="Re-enter password"/>
    </div>
    <button class="btn btn-primary" onclick="handleRegister()">Create Account</button>
    <div id="register-msg" class="status-msg"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- FORGOT PASSWORD TAB -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-forgot" class="tab-content">
    <div class="form-group">
      <label class="form-label">Email Address</label>
      <input type="email" class="form-input" id="forgot-email" placeholder="Enter your registered email"/>
    </div>
    <button class="btn btn-primary" onclick="handleForgotPassword()">Send Reset Link</button>
    <div class="link-text">
      <a onclick="switchTab('login')">Back to Login</a>
    </div>
    <div id="forgot-msg" class="status-msg"></div>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyCjTsSb2uKhZrzaaHHCOKICDeACXqg4v48",
  authDomain: "fiveroamcoffee-f6636.firebaseapp.com",
  projectId: "fiveroamcoffee-f6636",
  storageBucket: "fiveroamcoffee-f6636.firebasestorage.app",
  messagingSenderId: "911376181749",
  appId: "1:911376181749:web:fbfc3949e8ed0dff26d8bc"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVENT REDIRECT LOOP - CRITICAL FIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var isAuthenticating = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(function(btn){btn.classList.remove('active');});
  document.querySelectorAll('.tab-content').forEach(function(content){content.classList.remove('active');});
  
  if(tab === 'login'){
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('tab-login').classList.add('active');
  } else if(tab === 'register'){
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('tab-register').classList.add('active');
  } else if(tab === 'forgot'){
    document.getElementById('tab-forgot').classList.add('active');
  }
  clearAllMessages();
}

function clearAllMessages() {
  document.querySelectorAll('.status-msg').forEach(function(msg){
    msg.className = 'status-msg';
    msg.textContent = '';
  });
}

function showMessage(elementId, message, type) {
  var el = document.getElementById(elementId);
  el.className = 'status-msg ' + type;
  el.textContent = message;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleLogin() {
  var emailOrPhone = document.getElementById('login-email').value.trim();
  var password = document.getElementById('login-password').value.trim();

  if(!emailOrPhone || !password) {
    showMessage('login-msg', 'Please enter both email/phone and password', 'error');
    return;
  }

  isAuthenticating = true;
  showMessage('login-msg', 'Logging in...', 'info');

  // Check if input is phone number (starts with + or digits)
  var isPhone = /^[+\\d]/.test(emailOrPhone);
  
  if(isPhone) {
    // If phone number provided, fetch email from Firestore
    var phone = emailOrPhone.startsWith('+') ? emailOrPhone : '+91' + emailOrPhone;
    
    db.collection('users').where('phone', '==', phone).get()
      .then(function(querySnapshot) {
        if(querySnapshot.empty) {
          isAuthenticating = false;
          showMessage('login-msg', 'No account found with this phone number', 'error');
          return;
        }
        var email = querySnapshot.docs[0].data().email;
        loginWithEmail(email, password);
      })
      .catch(function(error) {
        isAuthenticating = false;
        showMessage('login-msg', 'Error: ' + error.message, 'error');
      });
  } else {
    // Direct email login
    loginWithEmail(emailOrPhone, password);
  }
}

function loginWithEmail(email, password) {
  auth.signInWithEmailAndPassword(email, password)
    .then(function(userCredential) {
      // Fetch user profile
      return db.collection('users').doc(userCredential.user.uid).get();
    })
    .then(function(doc) {
      var userData = doc.exists ? doc.data() : {};
      localStorage.setItem('frc_user', JSON.stringify({
        uid: auth.currentUser.uid,
        email: auth.currentUser.email,
        name: userData.name || '',
        phone: userData.phone || ''
      }));
      showMessage('login-msg', 'Login successful! Redirecting...', 'success');
      
      // CRITICAL: Wait before redirect to ensure localStorage is written
      setTimeout(function() {
        window.location.href = 'index.html';
      }, 1500);
    })
    .catch(function(error) {
      isAuthenticating = false;
      var msg = error.code === 'auth/wrong-password' ? 'Incorrect password' :
                error.code === 'auth/user-not-found' ? 'No account found with this email' :
                error.code === 'auth/invalid-email' ? 'Invalid email format' :
                error.message;
      showMessage('login-msg', msg, 'error');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleRegister() {
  var name = document.getElementById('reg-name').value.trim();
  var email = document.getElementById('reg-email').value.trim();
  var phone = document.getElementById('reg-phone').value.trim();
  var password = document.getElementById('reg-password').value.trim();
  var confirm = document.getElementById('reg-confirm').value.trim();

  if(!name || !email || !password || !confirm) {
    showMessage('register-msg', 'Please fill all required fields', 'error');
    return;
  }

  if(password !== confirm) {
    showMessage('register-msg', 'Passwords do not match', 'error');
    return;
  }

  if(password.length < 6) {
    showMessage('register-msg', 'Password must be at least 6 characters', 'error');
    return;
  }

  // Simple email validation
  if(!email.includes('@') || !email.includes('.')) {
    showMessage('register-msg', 'Invalid email format', 'error');
    return;
  }

  showMessage('register-msg', 'Creating account...', 'info');

  // Format phone if provided
  var formattedPhone = '';
  if(phone) {
    formattedPhone = phone.startsWith('+') ? phone : '+91' + phone.replace(/\\D/g, '');
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then(function(userCredential) {
      var user = userCredential.user;
      
      // Send email verification
      user.sendEmailVerification();
      
      // Store user profile in Firestore
      return db.collection('users').doc(user.uid).set({
        name: name,
        email: email,
        phone: formattedPhone,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .then(function() {
      showMessage('register-msg', 'Account created! Verification email sent. Redirecting to login...', 'success');
      
      // Clear form fields
      document.getElementById('reg-name').value = '';
      document.getElementById('reg-email').value = '';
      document.getElementById('reg-phone').value = '';
      document.getElementById('reg-password').value = '';
      document.getElementById('reg-confirm').value = '';
      
      setTimeout(function() {
        switchTab('login');
      }, 2500);
    })
    .catch(function(error) {
      var msg = error.code === 'auth/email-already-in-use' ? 'Email already registered' :
                error.code === 'auth/weak-password' ? 'Password is too weak' :
                error.message;
      showMessage('register-msg', msg, 'error');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORGOT PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleForgotPassword() {
  var email = document.getElementById('forgot-email').value.trim();

  if(!email) {
    showMessage('forgot-msg', 'Please enter your email', 'error');
    return;
  }

  showMessage('forgot-msg', 'Sending reset link...', 'info');

  auth.sendPasswordResetEmail(email)
    .then(function() {
      showMessage('forgot-msg', 'Password reset link sent to ' + email + '. Check your inbox!', 'success');
    })
    .catch(function(error) {
      var msg = error.code === 'auth/user-not-found' ? 'No account found with this email' :
                error.code === 'auth/invalid-email' ? 'Invalid email format' :
                error.message;
      showMessage('forgot-msg', msg, 'error');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-REDIRECT IF ALREADY LOGGED IN - FIXED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
auth.onAuthStateChanged(function(user) {
  // Only redirect if NOT currently authenticating and user exists
  if (user && !isAuthenticating) {
    var frcUser = localStorage.getItem('frc_user');
    // Only redirect if localStorage has the user data
    if(frcUser) {
      window.location.href = 'index.html';
    }
  }
});
</script>
</body>
</html>"""

with open('auth_fixed.html', 'w', encoding='utf-8') as f:
    f.write(auth_html_fixed)

print("âœ… Fixed auth.html created!")
print("\nğŸ”§ Critical Fixes Applied:")
print("1. Added 'isAuthenticating' flag to prevent redirect loop")
print("2. Increased redirect delay to 1.5s (ensures localStorage writes)")
print("3. Auth state listener now checks both user AND localStorage")
print("4. Fixed email validation (simple check)")
print("5. Added form field clearing after registration")
print("\nğŸ“ Replace your current auth.html with this fixed version")
print("File ready: auth_fixed.html")
